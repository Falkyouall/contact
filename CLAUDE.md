# Instructions for Claude

This document contains important instructions and notes for Claude when working on this project.

## CRITICAL GUIDELINES

### NEVER CREATE CONTENT WITHOUT CONSENT

- **NEVER CREATE BLOG POSTS OR SERVICE PAGES WITHOUT EXPLICIT CONSENT** from falk
- Do not write or propose new blog or service content unless specifically requested
- Only help with editing or fixing existing posts/services when asked

### USE GSED INSTEAD OF SED

- **ALWAYS USE `gsed` INSTEAD OF `sed`** for better compatibility across platforms
- `gsed` provides GNU sed features that are more consistent across Linux and macOS
- If editing files with sed-like operations, use `gsed` to ensure reliable results

### ALWAYS USE LATEST DEPENDENCIES

- **NEVER DOWNGRADE DEPENDENCIES** - Always use the latest stable versions
- **ALWAYS USE TOOLING TO CHECK VERSIONS** - Never guess or assume versions
- Run `pnpm outdated` to see what packages need updating
- Run `pnpm view [package] version` to check the latest published version
- When fixing dependency issues, always upgrade to the latest compatible versions
- Prioritize staying current with the ecosystem, even if it requires more work to adapt

### IMPORTANT: Development Server Limitation

- **DO NOT run `pnpm dev`** in agent mode - this will create an endless loop and stop the agent from working properly
- Instead, use `pnpm build` to verify your changes

## Tech Stack

| Technology | Package | Purpose |
|---|---|---|
| TanStack Start | `@tanstack/react-start` ^1.161.4 | Full-stack React meta-framework |
| TanStack Router | `@tanstack/react-router` ^1.161.4 | File-based routing |
| React | `react` ^19.2.4 | UI library |
| Vite | `vite` ^7.3.1 | Build tool and dev server |
| TailwindCSS | `tailwindcss` ^4.2.0 | Utility-first CSS |
| Paraglide | `@inlang/paraglide-js` ^2.12.0 | i18n (EN, DE, ES) |
| Zod | `zod` ^4.3.6 | Schema validation (contact form) |
| Resend | `resend` ^6.9.2 | Email API (contact form) |
| Sonner | `sonner` ^2.0.7 | Toast notifications |
| Unified/Remark/Rehype | `unified` ^11, `remark-parse`, `remark-rehype`, `rehype-stringify` | Markdown to HTML pipeline |
| gray-matter | `gray-matter` ^4.0.3 | Frontmatter parser for markdown |
| html-react-parser | `html-react-parser` ^5.2.17 | Render HTML strings as React elements |
| TypeScript | `typescript` ^5.9.3 | Type safety |
| pnpm | - | Package manager |
| Docker | - | Production container image |
| GitHub Actions | - | CI/CD for Docker image builds to `ghcr.io` |

## Project Structure

```
├── content/                        # Markdown content (per-locale)
│   ├── {en,de,es}/
│   │   ├── about.md                # About page (frontmatter: title)
│   │   ├── blog/*.md               # Blog posts (frontmatter: title, date, description)
│   │   └── services/*.md           # Service pages (frontmatter: title, subtitle, date, description)
├── messages/                       # i18n translation JSON files
│   ├── en.json                     # English UI strings (29 keys)
│   ├── de.json                     # German UI strings
│   └── es.json                     # Spanish UI strings
├── src/
│   ├── components/
│   │   ├── ContactForm.tsx         # Reusable contact form (standalone prop for page vs embedded)
│   │   ├── LanguageSwitcher.tsx    # EN/DE/ES switcher buttons
│   │   └── ThemeSwitcher.tsx       # Light/dark mode toggle
│   ├── lib/
│   │   ├── about.ts                # getAboutPage(locale) → { title, html }
│   │   ├── blog.ts                 # getAllPosts(locale), getPostBySlug(slug, locale)
│   │   ├── services.ts             # getAllServices(locale), getServiceBySlug(slug, locale)
│   │   ├── contact.ts              # handleContactSubmission(data) → sends email via Resend
│   │   ├── contact-schema.ts       # Zod schema + ContactFormData/ContactResult types
│   │   └── rate-limit.ts           # In-memory sliding-window rate limiter (5 req / 15 min per IP)
│   ├── paraglide/                  # Auto-generated by Paraglide plugin (do not edit)
│   ├── routes/
│   │   ├── __root.tsx              # Root layout: header, logo, lang/theme switchers, Toaster
│   │   ├── index.tsx               # Home page (/) with nav links
│   │   ├── about.tsx               # About page (/about) - loads locale markdown
│   │   ├── contact.tsx             # Contact page (/contact) - standalone ContactForm
│   │   ├── blog/
│   │   │   ├── index.tsx           # Blog listing (/blog)
│   │   │   └── $slug.tsx           # Blog post detail (/blog/:slug) + embedded ContactForm
│   │   └── services/
│   │       ├── index.tsx           # Services listing (/services)
│   │       └── $slug.tsx           # Service detail (/services/:slug) + embedded ContactForm
│   ├── styles/app.css              # Global CSS with Tailwind imports
│   ├── router.tsx                  # Router configuration
│   ├── routeTree.gen.ts            # Auto-generated route tree (do not edit)
│   └── server.ts                   # Server entry: wraps handler with Paraglide middleware
├── .env                            # RESEND_API_KEY, CONTACT_TO_EMAIL
├── Dockerfile                      # Multi-stage build (Node 22 slim)
├── vite.config.ts                  # Vite + TanStack Start + Paraglide + React + Tailwind
├── tsconfig.json                   # TS config (~/\* alias → src/\*)
└── project.inlang/settings.json    # Paraglide config (locales, message paths)
```

## Key Patterns

### Data Loading (Server Functions)

All data loading uses `createServerFn()` from `@tanstack/react-start`. The handler runs server-side only. TanStack Start automatically code-splits handlers out of the client bundle.

```tsx
// Define server function (in route file or component)
const fetchData = createServerFn().handler(() => {
  const locale = getLocale()       // From Paraglide AsyncLocalStorage
  return getDataByLocale(locale)
})

// Use in route loader
export const Route = createFileRoute('/path')({
  loader: () => fetchData(),
  component: MyComponent,
})

// Access in component
function MyComponent() {
  const data = Route.useLoaderData()
}
```

### Server Function Import Rules

- **NEVER use `.server.ts` file extensions** for files imported by routes or components. TanStack Start's import protection plugin blocks `**/*.server.*` imports in the client environment.
- Instead, use regular `.ts` files for server-only logic (e.g., `contact.ts`, `blog.ts`). The `createServerFn().handler()` body is automatically code-split to server-only.
- Server-specific imports like `getRequestIP` from `@tanstack/react-start/server` must only be called inside handler bodies or functions called by handlers.

### Markdown Content Pipeline

All content types (blog, services, about) follow the same pattern:

1. Markdown files live in `content/{locale}/{type}/` with YAML frontmatter
2. A lib file in `src/lib/` reads files with `fs`, parses frontmatter with `gray-matter`, converts markdown to HTML with `unified` + `remark-parse` + `remark-rehype` + `rehype-stringify`
3. All lib functions accept a `locale` parameter and fall back to English (`en`) if the locale file doesn't exist
4. Routes render HTML with `html-react-parser`'s `parse()` inside `<div className="prose prose-gray max-w-none dark:prose-invert">`

### i18n (Paraglide)

- **3 locales**: `en` (base), `de`, `es`
- **Strategy**: cookie → browser preference → base locale
- **Cookie**: `PARAGLIDE_LOCALE`
- **URL pattern**: English at `/`, German at `/de/`, Spanish at `/es/`
- **Messages**: `messages/{locale}.json` with flat key-value pairs
- **Usage in code**: `import * as m from '~/paraglide/messages'` then `m.key_name()`
- **Server-side locale**: `getLocale()` from `~/paraglide/runtime` uses AsyncLocalStorage (set by middleware in `server.ts`)
- **Generated files** in `src/paraglide/` are auto-generated on build. Do not edit.

### Contact Form

- **`ContactForm` component** accepts `{ standalone?: boolean }`:
  - `standalone`: renders `<h1>` heading, no top border (used on `/contact` page)
  - Embedded: renders `<h2>` heading with `mt-16 border-t` separator (used on blog post and service detail pages)
- **Server function** (`createServerFn`) is defined inside the component file itself
- **Validation**: client-side Zod `safeParse()` with i18n error messages, plus server-side `inputValidator(contactSchema)`
- **Honeypot**: hidden `website` field, bots filling it get silently accepted (no email sent)
- **Rate limiting**: 5 submissions per IP per 15 minutes (in-memory)
- **Email**: sent via Resend SDK, from `onboarding@resend.dev`, to `CONTACT_TO_EMAIL`, with reply-to set to sender's email
- **Toasts**: success/error/rate-limit feedback via Sonner

### Styling Conventions

- Dark mode via `dark:` Tailwind prefix, toggled by `.dark` class on `<html>`
- Content pages: `mx-auto max-w-2xl px-4 py-16`
- Prose content: `prose prose-gray max-w-none dark:prose-invert`
- Input fields: `border-gray-200 dark:border-gray-700`, `bg-white dark:bg-gray-800`, `focus:ring-2 focus:ring-black dark:focus:ring-white`
- Primary buttons: `bg-black text-white dark:bg-white dark:text-black`
- Links: `text-blue-600 hover:underline dark:text-blue-400`
- Error states: `border-red-500`, `text-red-500`

### Theme Persistence

The root layout injects an inline script to read `localStorage.getItem('theme')` before paint, preventing flash. The `ThemeSwitcher` component manages the `dark` class on `<html>` and listens for system preference changes.

## Environment Variables

| Variable | Purpose |
|---|---|
| `RESEND_API_KEY` | Resend SDK API key for sending contact form emails |
| `CONTACT_TO_EMAIL` | Recipient email address for contact form submissions |

Both are server-side only (accessed via `process.env` inside server function handlers).

## Common Tasks

1. **Adding a new route**:
   - Create a `.tsx` file in `src/routes/` (e.g., `about.tsx` → `/about`, `blog/$slug.tsx` → `/blog/:slug`)
   - `src/routeTree.gen.ts` auto-regenerates on build
   - Use `createFileRoute('/path')({ loader, component })` pattern

2. **Adding a new content type** (like blog or services):
   - Create `content/{en,de,es}/{type}/` directories with markdown files
   - Create `src/lib/{type}.ts` with read/parse functions (follow `blog.ts` pattern)
   - Create route files that use `createServerFn` to load content

3. **Adding i18n keys**:
   - Add keys to all three `messages/{en,de,es}.json` files
   - Paraglide regenerates `src/paraglide/` on build
   - Use `m.key_name()` in components

4. **Dependency updates**:
   ```bash
   pnpm outdated                           # See what needs updating
   pnpm view <package> version             # Check latest version
   pnpm update --latest                    # Update all
   pnpm build                              # Verify build passes
   ```
   Never downgrade. Diagnose and fix issues instead.

5. **Docker build**:
   ```bash
   docker build -t falk-portfolio .
   docker run -p 3000:3000 -e RESEND_API_KEY="..." -e CONTACT_TO_EMAIL="..." falk-portfolio
   ```

6. **Verifying changes**:
   ```bash
   pnpm build    # Always use this instead of pnpm dev in agent mode
   ```
